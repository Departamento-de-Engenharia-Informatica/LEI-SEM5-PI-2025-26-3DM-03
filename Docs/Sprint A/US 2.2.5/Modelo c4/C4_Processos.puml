@startuml C4_Register_Shipping_Agents_Process_View
title C4 – Register Shipping Agents (Process View – Create Organization)
hide footbox

actor "Organization Representative" as Rep
participant "Frontend Web App\n(React / Angular)" as Frontend
participant "Shipping Agents Management API\n(ASP.NET Core)" as API
participant "ShippingAgentService\n(Business rules)" as Service
participant "ShippingAgentMapper\n(DTO ↔ Domain)" as Mapper
participant "IShippingAgentRepository\n(Abstraction)" as Repo
participant "PortContext\n(Entity Framework Core)" as Context
database "PLMS Database\n(SQL / SQLite)" as DB
participant "Notification Providers\n(Email / SMS)" as Notif
participant "ASP.NET Auth Middleware\n(JWT validation)" as Auth
participant "External IAM Provider\n(OAuth 2.0 / OIDC)" as IAM

== Authentication ==
Rep -> Frontend : Sign in (credentials)
Frontend -> IAM : OAuth2/OIDC (PKCE)
IAM --> Frontend : Access Token (JWT)
Frontend -> API : Authorization: Bearer <JWT>
API -> Auth : Validate JWT (signature/claims)
Auth --> API : OK

== Submit Organization ==
Rep -> Frontend : Fill & submit form\n(TaxNumber, LegalName, AlternativeName,\nAddress, Representatives[≥1], Type)
Frontend -> API : POST /api/ShippingAgents\n(JSON + Bearer Token)

== Validation & Mapping ==
API -> Service : RegisterAsync(dto)
Service -> Service : Validate required fields\n- TaxNumber unique, names, address\n- ≥1 Representative (Name, CitizenID, Nationality, Email, Phone)
Service -> Mapper : ToDomain(dto)
Mapper --> Service : ShippingAgent

== Persistence ==
Service -> Repo : AddAsync(ShippingAgent)
Repo -> Context : Add + SaveChangesAsync()
Context -> DB : INSERT ShippingAgents + Representatives
DB --> Context : OK
Context --> Repo : OK
Repo --> Service : OK

== Notifications ==
API -> Notif : Send confirmation (Email/SMS)
Notif --> API : Accepted

== Response ==
Service --> API : ShippingAgentDTO
API --> Frontend : 201 Created (ShippingAgentDTO)
Frontend --> Rep : Show confirmation

@enduml
