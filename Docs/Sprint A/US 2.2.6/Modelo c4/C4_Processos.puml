@startuml C4_Manage_Representatives_Process_View
title C4 — System Sequence Diagram (Vista de Processos) — Manage Representatives
hide footbox

actor "Port Authority Officer" as Officer
participant "Frontend Web App\n(React / Angular)" as Frontend
participant "Representatives Management API\n(ASP.NET Core)" as API
participant "RepresentativeService\n(Business rules)" as Service
participant "RepresentativeMapper\n(DTO ↔ Domain)" as Mapper
participant "IShippingAgentRepository\n(Domain abstraction)" as Repo
participant "PortContext\n(Entity Framework Core)" as Context
database "PLMS Database\n(SQL / EF Core)" as DB

== Create Representative ==
Officer -> Frontend : Fill and submit form\n(Name, CitizenID, Nationality, PhoneNumber)
Frontend -> API : POST /api/shipping-agents/{taxNumber}/representatives\n(JSON request)
API -> Service : CreateAsync(taxNumber, dto)
Service -> Repo : GetByTaxNumberAsync(taxNumber, includeRepresentatives: true)
Repo -> Context : Query ShippingAgent + Representatives
Context -> DB : SELECT ShippingAgent by TaxNumber
DB --> Context : ShippingAgent found
Context --> Repo : OK
Repo --> Service : ShippingAgent entity
Service -> Service : Validate fields\nEnsure unique CitizenID per organization
Service -> Mapper : ToDomain(dto)
Mapper --> Service : Representative entity
Service -> Repo : Add Representative + SaveChangesAsync()
Repo -> Context : INSERT Representative
Context -> DB : Persist data
DB --> Context : OK
Service --> API : RepresentativeDTO
API --> Frontend : 201 Created (RepresentativeDTO)
Frontend --> Officer : Confirmation shown

== Update Representative ==
Officer -> Frontend : Edit representative details
Frontend -> API : PUT /api/shipping-agents/{taxNumber}/representatives/{id}\n(UpdateRepresentativeDTO)
API -> Service : UpdateAsync(taxNumber, id, dto)
Service -> Repo : GetByTaxNumberAsync(...) + find Representative
Service -> Mapper : Apply changes
Mapper --> Service : Updated Representative
Service -> Repo : SaveChangesAsync()
Repo -> Context : UPDATE Representative
Context -> DB : Save changes
DB --> Context : OK
Service --> API : Updated RepresentativeDTO
API --> Frontend : 200 OK

== Deactivate Representative ==
Officer -> Frontend : Deactivate representative
Frontend -> API : POST /api/shipping-agents/{taxNumber}/representatives/{id}/deactivate
API -> Service : DeactivateAsync(taxNumber, id)
Service -> Repo : GetByTaxNumberAsync(...) + find Representative
Service -> Service : rep.IsActive = false
Service -> Repo : SaveChangesAsync()
Repo -> Context : UPDATE Representative
Context -> DB : Save changes
DB --> Context : OK
API --> Frontend : 204 No Content

@enduml
