@startuml C3_Manage_Representatives_Process_View
title C3 — System Sequence Diagram (Vista de Processos) — Manage Representatives
hide footbox

actor "Port Authority Officer" as Officer
participant "RepresentativesController\n(API Layer)" as Controller
participant "RepresentativeService\n(Business rules & validation)" as Service
participant "RepresentativeMapper\n(DTO ↔ Domain)" as Mapper
participant "IShippingAgentRepository\n(Domain abstraction)" as Repo
participant "PortContext\n(Entity Framework Core)" as Context
database "PLMS Database\n(SQL / EF Core)" as DB

== CREATE REPRESENTATIVE ==
Officer -> Controller : POST /api/shipping-agents/{taxNumber}/representatives\n(CreateRepresentativeDTO + JWT)
Controller -> Service : CreateAsync(taxNumber, dto)

Service -> Repo : GetByTaxNumberAsync(taxNumber, includeRepresentatives: true)
Repo -> Context : Query ShippingAgent + Representatives
Context -> DB : SELECT ShippingAgent (by TaxNumber)
DB --> Context : Agent entity with Representatives
Context --> Repo : OK
Repo --> Service : ShippingAgent

Service -> Service : Validate(dto)\nEnsure unique CitizenID per organization
Service -> Mapper : ToDomain(dto)
Mapper --> Service : Representative (domain)
Service -> Repo : Add Representative + SaveChangesAsync()
Repo -> Context : SaveChanges()
Context -> DB : INSERT Representative
DB --> Context : OK
Context --> Repo : OK
Repo --> Service : OK

Service --> Controller : RepresentativeDTO
Controller --> Officer : HTTP 201 Created (RepresentativeDTO)

== UPDATE REPRESENTATIVE ==
Officer -> Controller : PUT /api/shipping-agents/{taxNumber}/representatives/{id}\n(UpdateRepresentativeDTO)
Controller -> Service : UpdateAsync(taxNumber, id, dto)
Service -> Repo : GetByTaxNumberAsync(...) + find Representative by Id
Service -> Mapper : MapToDomain(rep, dto)
Mapper --> Service : Updated Representative
Service -> Repo : SaveChangesAsync()
Repo -> Context : UPDATE Representative
Context -> DB : Save changes
DB --> Context : OK
Service --> Controller : Updated RepresentativeDTO
Controller --> Officer : HTTP 200 OK

== DEACTIVATE REPRESENTATIVE ==
Officer -> Controller : POST /api/shipping-agents/{taxNumber}/representatives/{id}/deactivate
Controller -> Service : DeactivateAsync(taxNumber, id)
Service -> Repo : GetByTaxNumberAsync(...) + find Representative
Service -> Service : rep.IsActive = false
Service -> Repo : SaveChangesAsync()
Repo -> Context : UPDATE Representative
Context -> DB : Save changes
DB --> Context : OK
Controller --> Officer : HTTP 204 No Content

@enduml
