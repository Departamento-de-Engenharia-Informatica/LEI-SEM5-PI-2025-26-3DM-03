name: Deploy TodoApi

on:
  push:
    branches: [ main ]
    paths:
      - 'TodoApi/**'
      - 'frameworkDDD/**'
      - '.github/workflows/deploy-todoapi.yml'
  workflow_dispatch:
    inputs:
      runTestsOnly:
        description: 'Run build & tests without container push'
        type: boolean
        default: false
      disableOidc:
        description: 'Disable OIDC (DISABLE_OIDC=true)'
        type: boolean
        default: true
      imageTag:
        description: 'Custom image tag'
        required: false
      deployToDei:
        description: 'Deploy to DEI VM (self-hosted runner)'
        type: boolean
        default: false
      containerName:
        description: 'Container name on DEI VM'
        required: false
        default: 'todoapi'
      hostPort:
        description: 'Host port to expose TodoApi'
        required: false
        default: '8080'

  schedule:
    - cron: '0 2 * * *' # nightly at 02:00 UTC


permissions:
  contents: read
  packages: write


# -------------------------
#   JOB 1 — Build + Tests
# -------------------------
jobs:
  build-test:
    runs-on: ubuntu-latest
    env:
      DOTNET_NOLOGO: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore LEI-SEM5-PI-2025-26-3DM-03.sln

      - name: Build
        run: dotnet build LEI-SEM5-PI-2025-26-3DM-03.sln --configuration Release --no-restore

      - name: Test suite
        run: |
          echo "Running tests..."
          dotnet test testes/Domain.Tests/Domain.Tests.csproj \
            --configuration Release \
            --no-build \
            --logger "trx;LogFileName=tests.trx" \
            /p:CollectCoverage=true \
            /p:CoverletOutput=../../TestResults/ \
            /p:CoverletOutputFormat=cobertura

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/TestResults/*.trx
            **/TestResults/*.xml
          retention-days: 30


# -------------------------
#   JOB 2 — Build & Push Image
# -------------------------
  containerize:
    needs: build-test
    if: ${{ inputs.runTestsOnly != 'true' }}
    runs-on: ubuntu-latest
    outputs:
      image_repo: ${{ steps.image.outputs.image }}
      image_tag: ${{ steps.meta.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image repo
        id: image
        run: |
          REPO_LC="${GITHUB_REPOSITORY,,}"
          echo "image=ghcr.io/${REPO_LC}-todoapi" >> $GITHUB_OUTPUT

      - name: Compute image tag
        id: meta
        run: |
          DATE=$(date +%Y%m%d-%H%M)
          SHA=$(echo $GITHUB_SHA | cut -c1-7)
          echo "image_tag=${DATE}-${SHA}" >> $GITHUB_OUTPUT

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: TodoApi/Dockerfile
          push: true
          tags: |
            ${{ steps.image.outputs.image }}:${{ steps.meta.outputs.image_tag }}
            ${{ steps.image.outputs.image }}:latest

      # --- SMOKE TEST NÃO BLOQUEANTE ---
      - name: Smoke test container (non-blocking)
        continue-on-error: true
        run: |
          echo "Starting smoke test container..."
          docker rm -f todoapi-smoke || true

          docker run -d --name todoapi-smoke \
            -p 8080:8080 \
            -e DISABLE_OIDC=true \
            ${{ steps.image.outputs.image }}:${{ steps.meta.outputs.image_tag }}

          echo "Waiting 20s for app to start..."
          sleep 20

          echo "Calling http://localhost:8080/WeatherForecast ..."
          if curl --fail http://localhost:8080/WeatherForecast; then
            echo "Smoke test PASSED"
          else
            echo "Smoke test FAILED (app not ready or misconfigured)"
          fi

          echo "Collecting container logs..."
          docker logs todoapi-smoke || true
          docker logs todoapi-smoke > smoke.log || true

          echo "Cleaning up smoke container..."
          docker rm -f todoapi-smoke || true

      - name: Upload smoke test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test
          path: smoke.log
          retention-days: 14


# -------------------------
#   JOB 3 — Deploy to VM
# -------------------------
  deploy-to-dei:
    needs: containerize
    if: ${{ inputs.deployToDei == 'true' }}
    runs-on: [self-hosted, Linux, X64]
    steps:
      - name: Prepare variables
        id: prep
        run: |
          echo "image=${{ needs.containerize.outputs.image_repo }}:${{ needs.containerize.outputs.image_tag }}" >> $GITHUB_OUTPUT
          echo "cname=${{ inputs.containerName }}" >> $GITHUB_OUTPUT
          echo "hport=${{ inputs.hostPort }}" >> $GITHUB_OUTPUT

      - name: Login to GHCR from VM
        run: |
          echo "${GHCR_PAT}" | docker login ghcr.io -u "${GHCR_USER}" --password-stdin
        env:
          GHCR_USER: ${{ secrets.GHCR_USER }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}

      - name: Pull and deploy container
        run: |
          IMAGE="${{ steps.prep.outputs.image }}"
          NAME="${{ steps.prep.outputs.cname }}"
          PORT="${{ steps.prep.outputs.hport }}"

          echo "Pulling image: $IMAGE"
          docker pull "$IMAGE"

          echo "Stopping previous container..."
          docker rm -f "$NAME" || true

          echo "Starting new container on port $PORT"
          docker run -d --name "$NAME" \
            --restart unless-stopped \
            -e DISABLE_OIDC=true \
            -p "$PORT":8080 \
            "$IMAGE"

          echo "Running containers:"
          docker ps


# -------------------------
#   JOB 4 — Summary
# -------------------------
  summary:
    needs: [build-test, containerize, deploy-to-dei]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "Pipeline completed with:"
          echo "- Tests OK"
          echo "- Image pushed to GHCR"
          echo "- Smoke test executed (non-blocking, logs as artifact)"
          echo "- Deploy executed on DEI VM (if enabled)"
