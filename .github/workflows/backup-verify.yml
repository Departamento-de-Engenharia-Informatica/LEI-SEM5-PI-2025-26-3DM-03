name: Backup Verify Restore

on:
  schedule:
    # Dia 1 de cada mês às 03:00 UTC
    - cron: '0 3 1 * *'
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  verify-restore:
    runs-on: ubuntu-latest
    env:
      BACKUP_OUT: backup_out
      DB_TYPE: sqlite

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install sqlite3
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3

      - name: Seed ephemeral SQLite
        run: |
          set -e
          sqlite3 demo.db "CREATE TABLE IF NOT EXISTS demo(id INTEGER PRIMARY KEY, note TEXT);"
          sqlite3 demo.db "INSERT INTO demo(note) VALUES ('seed row 1'),('seed row 2');"

      - name: Create full backup from SQLite
        env:
          DB_CONNECTION: demo.db
          DB_TYPE: sqlite
        run: |
          set -e
          mkdir -p "$BACKUP_OUT"
          chmod +x scripts/backup-db.sh
          ./scripts/backup-db.sh --type full --out "$BACKUP_OUT"

      - name: Verify backup integrity (PRAGMA + row count)
        run: |
          set -e
          file=$(ls -1 ${BACKUP_OUT}/*.sqlite.gz 2>/dev/null | tail -n1)
          if [ -z "$file" ]; then
            echo "No .sqlite.gz backup found to verify." >&2
            exit 1
          fi
          gunzip -c "$file" > /tmp/restore.sqlite
          echo "Integrity check:"
          sqlite3 /tmp/restore.sqlite "PRAGMA integrity_check;"
          echo "Row count in demo:"
          sqlite3 /tmp/restore.sqlite "SELECT COUNT(*) FROM demo;"

      - name: Upload verify artifacts (7 days)
        uses: actions/upload-artifact@v4
        with:
          name: backup-verify-${{ github.run_id }}
          path: |
            backup_out/*.gz
            backup_out/*.sha256
            backup_out/manifest-*.json
          retention-days: 7
