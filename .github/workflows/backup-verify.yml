name: Backup Verify Restore

on:
  schedule:
    - cron: '0 3 * * 0' # weekly Sunday 03:00 UTC
  workflow_dispatch: {}

jobs:
  verify-restore:
    runs-on: ubuntu-latest
    env:
      BACKUP_OUT: backup_out
      DB_TYPE: sqlite
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install sqlite3
        run: sudo apt-get update && sudo apt-get install -y sqlite3

      - name: Seed ephemeral SQLite
        run: |
          set -e
          sqlite3 demo.db "CREATE TABLE IF NOT EXISTS demo(id INTEGER PRIMARY KEY, note TEXT); INSERT INTO demo(note) VALUES ('seed row 1'),('seed row 2');"

      - name: Create full backup from SQLite
        env:
          DB_CONNECTION: demo.db
          DB_TYPE: sqlite
        run: |
          set -e
          mkdir -p "$BACKUP_OUT"
          chmod +x scripts/backup-db.sh
          ./scripts/backup-db.sh --type full --out "$BACKUP_OUT"

      - name: Verify backup integrity (PRAGMA)
        run: |
          set -e
          file=$(ls -1 ${BACKUP_OUT}/*.sqlite.gz | tail -n1)
          gunzip -c "$file" > /tmp/restore.sqlite
          sqlite3 /tmp/restore.sqlite "PRAGMA integrity_check;"
          echo "Row count:"; sqlite3 /tmp/restore.sqlite "SELECT COUNT(*) FROM demo;" || true

      - name: Upload verify artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backup-verify-${{ github.run_id }}
          path: |
            backup_out/*.gz
            backup_out/*.sha256
            backup_out/manifest-*.json
          retention-days: 7
