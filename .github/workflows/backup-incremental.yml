name: Backup Database (Incremental)

on:
  schedule:
    # Incremental a cada 15 minutos (RPO <= 15m)
    - cron: '*/15 * * * *'
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  incremental:
    # Só corre se a variável do repositório estiver ativa
    if: ${{ vars.ENABLE_INCREMENTAL == 'true' }}
    runs-on: ubuntu-latest
    env:
      BACKUP_OUT: backup_out
      DB_TYPE: sqlite
      DB_CONNECTION: ${{ secrets.DB_CONNECTION }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      BACKUP_BUCKET: ${{ secrets.BACKUP_BUCKET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools (sqlite3, awscli)
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3
          pipx install awscli || pip install --user awscli || true

      - name: Ensure output dir
        run: mkdir -p "${BACKUP_OUT}"

      - name: Detect SQLite db file
        id: find_sqlite
        run: |
          set -e
          if [ -f "port.db" ]; then
            echo "has_sqlite=true" >> $GITHUB_OUTPUT
            echo "path=port.db" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ -f "TodoApi/port.db" ]; then
            echo "has_sqlite=true" >> $GITHUB_OUTPUT
            echo "path=TodoApi/port.db" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "has_sqlite=false" >> $GITHUB_OUTPUT

      - name: Run incremental backup
        id: run_backup
        if: ${{ env.DB_CONNECTION != '' || steps.find_sqlite.outputs.has_sqlite == 'true' }}
        run: |
          chmod +x scripts/backup-db.sh
          ./scripts/backup-db.sh --type incremental --out "${BACKUP_OUT}"

      - name: Fail (DB not configured)
        if: ${{ env.DB_CONNECTION == '' && steps.find_sqlite.outputs.has_sqlite != 'true' }}
        run: |
          echo "ERROR: SQLite DB not found and DB_CONNECTION empty; cannot run incremental backup." >&2
          exit 1

      - name: Upload incremental artifact (7 days)
        if: ${{ steps.run_backup.outcome == 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: db-incremental-${{ github.run_id }}
          path: |
            ${{ env.BACKUP_OUT }}/*.gz
            ${{ env.BACKUP_OUT }}/*.sha256
            ${{ env.BACKUP_OUT }}/manifest-*.json
          retention-days: 7

      - name: Upload incremental to AWS S3 (optional off-site)
        if: ${{ env.AWS_ACCESS_KEY_ID != '' && env.AWS_SECRET_ACCESS_KEY != '' && env.BACKUP_BUCKET != '' }}
        run: |
          set -e
          ts=$(date -u +%Y%m%d-%H%M%S)
          prefix="incremental/$ts"
          aws s3 cp "${BACKUP_OUT}/" "s3://${BACKUP_BUCKET}/${prefix}/" \
            --recursive --region "${AWS_REGION:-eu-west-1}"
