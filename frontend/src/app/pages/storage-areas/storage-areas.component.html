<div class="storage-page">
  <header class="page-header">
    <div class="title-block">
      <h1>√Åreas de Armazenamento</h1>
      <p>Coordena a capacidade de armazenagem do porto com visibilidade r√°pida de ocupa√ß√£o.</p>
    </div>

    <div class="header-controls">
      <div class="search-field">
        <span class="search-icon">üîç</span>
        <input
          type="search"
          placeholder="Pesquisar por localiza√ß√£o ou tipo..."
          [(ngModel)]="q"
          (ngModelChange)="applyFilterSort()"
        />
        <button
          type="button"
          class="clear-btn"
          *ngIf="q"
          (click)="q=''; applyFilterSort();"
          aria-label="Limpar pesquisa"
        >
          ‚úï
        </button>
      </div>

      <div class="sort-field">
        <label>Ordenar por</label>
        <div class="sort-input">
          <select [(ngModel)]="sortKey" (change)="applyFilterSort()">
            <option value="location">Localiza√ß√£o</option>
            <option value="type">Tipo</option>
            <option value="maxCapacityTEU">Capacidade</option>
            <option value="currentOccupancyTEU">Ocupa√ß√£o</option>
          </select>
          <button class="icon-toggle" type="button" (click)="changeSort(sortKey)">
            {{ sortDir === 'asc' ? '‚ñ≤' : '‚ñº' }}
          </button>
        </div>
      </div>
    </div>
  </header>

  <section class="status-row" *ngIf="loading || error">
    <div *ngIf="loading" class="status-pill muted">A carregar √°reas...</div>
    <div *ngIf="error" class="status-pill error">{{ error }}</div>
  </section>

  <section class="summary-grid" *ngIf="summaryMetrics.length">
    <article
      class="summary-card"
      *ngFor="let metric of summaryMetrics"
      [class.summary-card--highlight]="metric.highlight"
    >
      <div class="summary-icon" aria-hidden="true">{{ metric.icon }}</div>
      <div class="summary-info">
        <span class="summary-label">{{ metric.label }}</span>
        <span class="summary-value">{{ metric.value }}</span>
        <span class="summary-hint">{{ metric.hint }}</span>
      </div>
    </article>
  </section>

  <div class="layout" *ngIf="!loading">
    <aside class="card form-card">
      <header class="card-header">
        <h2>Criar nova √°rea</h2>
        <p>Preenche os campos e cria a √°rea instantaneamente.</p>
      </header>

      <form (ngSubmit)="create()" class="form">
        <label>
          <span>Localiza√ß√£o</span>
          <input [(ngModel)]="newArea.location" name="location" required />
        </label>

        <label>
          <span>Tipo</span>
          <select [(ngModel)]="newArea.type" name="type">
            <option value="Yard">Yard</option>
            <option value="Warehouse">Warehouse</option>
          </select>
        </label>

        <div class="row metrics-grid">
          <label class="metric-field">
            <span>Capacidade</span>
            <div class="input-with-unit">
              <input type="number" [(ngModel)]="newArea.maxCapacityTEU" name="capacity" min="0" />
              <span class="unit">TEU</span>
            </div>
          </label>
          <label class="metric-field">
            <span>Ocupa√ß√£o</span>
            <div class="input-with-unit">
              <input type="number" [(ngModel)]="newArea.currentOccupancyTEU" name="occupancy" min="0" />
              <span class="unit">TEU</span>
            </div>
          </label>
        </div>

        <button class="btn primary full" type="submit">Criar</button>
      </form>
    </aside>

    <main class="card list-card">
      <header class="list-header">
        <div>
          <h2>Lista de √Åreas</h2>
          <p>{{ filtered.length }} √°rea(s) a mostrar</p>
        </div>
      </header>

      <table class="table" *ngIf="filtered.length; else emptyState">
        <thead>
          <tr>
            <th (click)="changeSort('location')">Localiza√ß√£o</th>
            <th (click)="changeSort('type')">Tipo</th>
            <th (click)="changeSort('maxCapacityTEU')">Capacidade</th>
            <th (click)="changeSort('currentOccupancyTEU')">Ocupa√ß√£o</th>
            <th class="right">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let area of filtered">
            <td>
              <div class="cell-main">
                <span class="cell-title">{{ area.location }}</span>
                <span class="cell-sub">{{ area.type }}</span>
              </div>
            </td>
            <td>
              <span class="badge" [class.badge-alt]="area.type === 'Warehouse'">{{ area.type }}</span>
            </td>
            <td>
              <div class="stat">
                <span class="stat-value">{{ area.maxCapacityTEU ?? '‚Äî' }}</span>
                <span class="stat-hint">Cap.</span>
              </div>
            </td>
            <td>
              <div class="occupancy">
                <div class="progress" role="presentation">
                  <div
                    class="progress-bar"
                    [style.width.%]="getOccupancyPercent(area) ?? 0"
                  ></div>
                </div>
                <div class="progress-meta">
                  <span>{{ area.currentOccupancyTEU ?? 0 }} / {{ area.maxCapacityTEU ?? '‚Äî' }} TEU</span>
                  <span class="percent" *ngIf="getOccupancyPercent(area) !== null">
                    {{ percentFormatter.format(getOccupancyPercent(area)!) }}%
                  </span>
                </div>
              </div>
            </td>
            <td class="right actions">
              <button class="icon-btn" type="button" (click)="openEdit(area)" aria-label="Editar √°rea">
                ‚úé
              </button>
              <button class="icon-btn danger" type="button" (click)="delete(area.id)" aria-label="Eliminar √°rea">
                üóë
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <ng-template #emptyState>
        <div class="empty-state">
          <div class="emoji">üì¶</div>
          <p>Sem resultados. Cria uma nova √°rea √† esquerda.</p>
        </div>
      </ng-template>
    </main>
  </div>

  <div class="modal-backdrop" *ngIf="editing">
    <div class="modal">
      <header class="modal-header">
        <div>
          <h3>Editar √°rea</h3>
          <p>Atualiza os dados e guarda para sincronizar com o Backoffice.</p>
        </div>
        <button class="icon-btn" type="button" (click)="closeEdit()" aria-label="Fechar">‚úï</button>
      </header>

      <form (ngSubmit)="saveEdit()" class="form">
        <label>
          <span>Localiza√ß√£o</span>
          <input [(ngModel)]="editing!.location" name="edit_location" required />
        </label>
        <label>
          <span>Tipo</span>
          <select [(ngModel)]="editing!.type" name="edit_type">
            <option value="Yard">Yard</option>
            <option value="Warehouse">Warehouse</option>
          </select>
        </label>
        <div class="row metrics-grid">
          <label class="metric-field">
            <span>Capacidade</span>
            <div class="input-with-unit">
              <input type="number" [(ngModel)]="editing!.maxCapacityTEU" name="edit_capacity" min="0" />
              <span class="unit">TEU</span>
            </div>
          </label>
          <label class="metric-field">
            <span>Ocupa√ß√£o</span>
            <div class="input-with-unit">
              <input type="number" [(ngModel)]="editing!.currentOccupancyTEU" name="edit_occupancy" min="0" />
              <span class="unit">TEU</span>
            </div>
          </label>
        </div>

        <div class="modal-actions">
          <button class="btn" type="button" (click)="closeEdit()">Cancelar</button>
          <button class="btn primary" type="submit">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>
