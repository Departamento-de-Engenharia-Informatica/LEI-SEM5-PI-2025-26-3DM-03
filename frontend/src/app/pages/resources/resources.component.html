<div class="resources-container page resources-like">
  <div class="page-header">
    <div>
      <h2 class="page-title">Resources</h2>
      <p class="muted subtitle">Manage resources available in the system</p>
    </div>
    <div class="header-actions"></div>
  </div>

  <div *ngIf="error" class="alert alert-error">{{ error }}</div>
  <div *ngIf="loading" class="loading">A carregar...</div>

  <div class="toolbar" *ngIf="!loading && !showForm">
    <div class="search-input">
      <i class="bi bi-search"></i>
      <input type="text" [(ngModel)]="q" (ngModelChange)="applyFilterSort()" placeholder="Search resources..." />
    </div>
    <div class="toolbar-actions">
      <button class="btn-clear" type="button" (click)="clearSearch()">Clear</button>
      <button type="button" class="btn-primary" (click)="onCreateClick()"><i class="bi bi-plus-lg"></i> Create resource</button>
    </div>
  </div>

  <div class="card table-card" *ngIf="!loading && !showForm">
    <table class="tbl">
      <thead>
        <tr>
          <th (click)="changeSort('code')">Code</th>
          <th (click)="changeSort('type')">Type</th>
          <th (click)="changeSort('status')">Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of filtered">
          <td class="col-code">{{ r.code }}</td>
          <td class="col-type">{{ r.type }}</td>
          <td class="col-status">
            <span class="badge" [class.badge-green]="isActiveStatus(r.status)" [class.badge-gray]="!isActiveStatus(r.status)">{{ r.status }}</span>
          </td>
          <td class="actions col-actions">
            <button type="button" class="btn-ghost" (click)="editResource(r)" [disabled]="saving"><i class="bi bi-pencil"></i></button>
            <button type="button" class="btn-ghost danger" (click)="remove(r)" [disabled]="removingCodes.has(r.code)"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <section class="card" *ngIf="showForm && currentResource as form">
    <h3>{{ isEditing ? ('Edit ' + (form.code ?? '')) : 'New resource' }}</h3>
    <form (ngSubmit)="save()" autocomplete="off">
      <div class="form-grid">
        <label>Code
          <input [(ngModel)]="form.code" name="code" [disabled]="isEditing" />
        </label>
        <label>Description
          <input [(ngModel)]="form.description" name="description" />
        </label>
        <label>Type
          <select [(ngModel)]="form.type" name="type">
            <option *ngFor="let option of typeOptions" [value]="option">{{ option }}</option>
          </select>
        </label>
        <label>Setup time (min)
          <input type="number" [(ngModel)]="form.setupTimeMinutes" name="setupTimeMinutes" />
        </label>
        <label>Capacity
          <input type="number" [(ngModel)]="form.operationalCapacity" name="operationalCapacity" />
        </label>
        <label>Assigned area
          <input [(ngModel)]="form.assignedArea" name="assignedArea" />
        </label>
        <label *ngIf="isEditing" class="status-field">
          Status
          <select [(ngModel)]="form.status" name="status">
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
            <option value="UnderMaintenance">UnderMaintenance</option>
          </select>
        </label>
        <label class="qualifications-chooser" [ngClass]="{ 'centered': !isEditing, 'flush': isEditing }">Required qualifications
          <ng-container *ngIf="availableQualifications.length; else noQualifications">
            <div class="qualifications-field">
              <select [(ngModel)]="selectedQualification"
                      name="selectedQualification"
                      (ngModelChange)="onQualificationSelected($event)">
                <option value="" disabled hidden>Select a qualification...</option>
                <option *ngFor="let qual of availableQualifications" [value]="qual.code">
                  {{ qual.code }} - {{ qual.description }}
                </option>
              </select>
              <div class="selected-qualifications">
                <span class="chip" *ngFor="let code of form.requiredQualifications">
                  {{ code }}
                  <button type="button" (click)="removeQualification(code)" aria-label="Remove qualification">Ã—</button>
                </span>
              </div>
            </div>
          </ng-container>
        </label>
        <ng-template #noQualifications>
          <div class="muted qualifications-field">No qualifications available. Create them first.</div>
        </ng-template>
      </div>
      <div class="actions">
        <button class="btn-primary" type="submit" [disabled]="saving">Save</button>
        <button class="btn-ghost" type="button" (click)="cancel()">Cancel</button>
      </div>
    </form>
    <div *ngIf="formError" class="alert alert-error">{{ formError }}</div>
    <div *ngIf="successMessage" class="alert">{{ successMessage }}</div>
  </section>
</div>
