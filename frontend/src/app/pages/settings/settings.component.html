<div class="settings-page">
  <h2>Settings - Users</h2>

  <div *ngIf="error" class="error">{{ error }}</div>

  <section class="create">
    <h3>Add user</h3>
    <div class="row">
      <input placeholder="Email" [(ngModel)]="newEmail" />
      <input placeholder="Name" [(ngModel)]="newName" />
      <select [(ngModel)]="newRoleId">
        <option *ngFor="let r of roles" [ngValue]="r.id">{{ r.name }}</option>
      </select>
      <button class="btn-primary" (click)="create()">Add</button>
    </div>
  </section>

  <section class="list">
    <h3>Users</h3>
    <table>
      <thead><tr><th>Email</th><th>Name</th><th>Roles</th><th>Status</th><th>1º acesso</th><th>Mudança de roles</th><th>Actions</th></tr></thead>
      <tbody>
        <tr *ngFor="let u of users">
          <td>{{ u.email }}</td>
          <td>{{ u.name }}</td>
          <td>
            <div class="role-grid">
              <label *ngFor="let r of roles">
                <input type="checkbox" [checked]="userHasRole(u, r.id)" (change)="toggleRole(u, r.id, $event)" />
                <span>{{ r.name }}</span>
              </label>
            </div>
          </td>
          <td>
            <span class="badge" [class.badge-active]="u.active" [class.badge-inactive]="!u.active">{{ u.active ? 'Ativo' : 'Inativo' }}</span>
          </td>
          <td>
            <div class="activation-cell">
              <span *ngIf="u.activation?.pending" class="pending">Link pendente</span>
              <span *ngIf="!u.activation?.pending && u.activation?.lastRedeemedUtc" class="complete">Ativado em {{ u.activation.lastRedeemedUtc | date:'short' }}</span>
              <small *ngIf="u.activation?.lastSentUtc">Último envio: {{ u.activation.lastSentUtc | date:'short' }}</small>
              <button class="btn-ghost" (click)="sendActivation(u)" [disabled]="u.active || !u.roles || u.roles.length === 0">Enviar link</button>
              <div class="activation-link" *ngIf="lastActivationLink[u.id]">
                <small>Link copiado:</small>
                <code>{{ lastActivationLink[u.id].link }}</code>
              </div>
            </div>
          </td>
          <td>
            <div class="activation-cell">
              <span *ngIf="u.roleChange?.lastSentUtc; else noRoleChange">
                <small>Último envio: {{ u.roleChange.lastSentUtc | date:'short' }}</small><br>
                <span *ngIf="u.roleChange?.summary">Papeis: {{ u.roleChange.summary }}</span><br>
                <span *ngIf="u.roleChange?.confirmedUtc" class="complete">Confirmado em {{ u.roleChange.confirmedUtc | date:'short' }}</span>
                <span *ngIf="!u.roleChange?.confirmedUtc" class="pending">Aguardando confirmação</span>
              </span>
              <ng-template #noRoleChange><small>Sem alterações recentes</small></ng-template>
            </div>
          </td>
          <td>
            <button class="btn-ghost" (click)="toggleActive(u)">{{ u.active ? 'Desativar' : 'Ativar' }}</button>
            <button class="btn-ghost" (click)="remove(u)">Remover</button>
          </td>
        </tr>
      </tbody>
    </table>
  </section>
</div>
